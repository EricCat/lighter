// Generated by CoffeeScript 1.3.3
(function() {

  module.exports = function(mongoose) {
    var Blog;
    Blog = (function() {

      function Blog(mongoose) {
        var CategoriesSchema, CommentsSchema, ObjectId, PostSchema, Schema;
        Schema = mongoose.Schema;
        ObjectId = Schema.ObjectId;
        CategoriesSchema = new Schema({
          title: String
        });
        CommentsSchema = new Schema({
          title: String,
          text: String,
          date: Date
        });
        PostSchema = new Schema({
          author: String,
          title: String,
          permaLink: String,
          body: String,
          date: Date,
          categories: [CategoriesSchema],
          comments: [CommentsSchema],
          publish: Boolean
        });
        this.Post = mongoose.model('post', PostSchema);
        this.helper = (require(__dirname + '/helper'))();
      }

      Blog.prototype.create = function(obj, callback) {
        var link,
          _this = this;
        link = this.helper.linkify(obj.title);
        return this.findByPermaLink(link, function(data) {
          var post;
          if (data === null) {
            post = new _this.Post({
              title: obj.title,
              permaLink: link,
              author: obj.author,
              body: obj.body,
              publish: 1,
              date: new Date()
            });
            return post.save(function(err, data) {
              if (err !== null) {
                throw err.message;
              }
              callback(data);
            });
          } else {
            return callback("duplicate post");
          }
        });
      };

      Blog.prototype.findByPermaLink = function(permaLink, callback) {
        return this.Post.findOne({
          permaLink: permaLink
        }, function(err, data) {
          if (err !== null) {
            throw err.message;
          }
          callback(data);
        });
      };

      Blog.prototype.findAll = function(callback) {
        return this.Post.find(function(err, data) {
          if (err !== null) {
            throw err.message;
          }
          callback(data);
        });
      };

      Blog.prototype.removeAll = function() {
        return this.Post.remove({}, function() {
          return console.log("completed");
        });
      };

      return Blog;

    })();
    return new Blog(mongoose);
  };

}).call(this);
